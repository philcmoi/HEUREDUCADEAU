<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Commande - HEURE DU CADEAU</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .order-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 30px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }
      .order-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
      }
      .step {
        text-align: center;
        flex: 1;
        padding: 15px;
        opacity: 0.5;
      }
      .step.active {
        opacity: 1;
        color: #27ae60;
        font-weight: bold;
      }
      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #eee;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
      }
      .step.active .step-number {
        background: #27ae60;
        color: white;
      }
      .order-items {
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
      }
      .order-summary {
        text-align: right;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #eee;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="order-container">
        <h1>Finalisation de votre commande</h1>

        <div class="order-steps">
          <div class="step active">
            <div class="step-number">1</div>
            <div>Panier</div>
          </div>
          <div class="step active">
            <div class="step-number">2</div>
            <div>Livraison</div>
          </div>
          <div class="step">
            <div class="step-number">3</div>
            <div>Paiement</div>
          </div>
          <div class="step">
            <div class="step-number">4</div>
            <div>Confirmation</div>
          </div>
        </div>

        <div id="orderContent">
          <h2>Formulaire de livraison</h2>
          <p>Veuillez remplir vos informations de livraison :</p>

          <form id="orderForm" style="margin-top: 20px">
            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
              "
            >
              <div>
                <label>Prénom *</label>
                <input
                  type="text"
                  id="prenom"
                  required
                  style="width: 100%; padding: 10px"
                />
              </div>
              <div>
                <label>Nom *</label>
                <input
                  type="text"
                  id="nom"
                  required
                  style="width: 100%; padding: 10px"
                />
              </div>
            </div>

            <div style="margin-bottom: 20px">
              <label>Email *</label>
              <input
                type="email"
                id="email"
                required
                style="width: 100%; padding: 10px"
              />
            </div>

            <div style="margin-bottom: 20px">
              <label>Adresse *</label>
              <textarea
                id="adresse"
                rows="3"
                required
                style="width: 100%; padding: 10px"
              ></textarea>
            </div>

            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
              "
            >
              <div>
                <label>Code Postal *</label>
                <input
                  type="text"
                  id="code_postal"
                  required
                  style="width: 100%; padding: 10px"
                />
              </div>
              <div>
                <label>Ville *</label>
                <input
                  type="text"
                  id="ville"
                  required
                  style="width: 100%; padding: 10px"
                />
              </div>
            </div>

            <div style="margin-bottom: 20px">
              <label>Téléphone *</label>
              <input
                type="tel"
                id="telephone"
                required
                style="width: 100%; padding: 10px"
              />
            </div>

            <div id="orderSummary" class="order-summary">
              <!-- Récapitulatif chargé par JavaScript -->
            </div>

            <div style="margin-top: 30px">
              <button
                type="button"
                onclick="submitOrder()"
                style="
                  padding: 15px 30px;
                  background: #27ae60;
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 16px;
                  cursor: pointer;
                "
              >
                Continuer vers le paiement
              </button>
              <a href="panier.html" style="margin-left: 15px; color: #3498db"
                >Retour au panier</a
              >
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      async function loadOrderSummary() {
        try {
          const response = await fetch("api/panier.php?action=get");
          const data = await response.json();

          if (data.success && data.panier) {
            let html = "<h3>Récapitulatif de votre commande</h3>";
            html += '<div class="order-items">';
            data.panier.forEach((item) => {
              html += `
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                                <div>
                                    <strong>${item.nom}</strong><br>
                                    <small>Réf: ${item.reference}</small>
                                </div>
                                <div>
                                    ${item.quantite} x ${parseFloat(
                item.prix_unitaire
              ).toFixed(2)} € = 
                                    <strong>${parseFloat(
                                      item.prix_total
                                    ).toFixed(2)} €</strong>
                                </div>
                            </div>
                        `;
            });

            html += `</div>
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Sous-total (${data.total_items} article${
              data.total_items > 1 ? "s" : ""
            })</span>
                            <span><strong>${parseFloat(data.sous_total).toFixed(
                              2
                            )} €</strong></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Livraison</span>
                            <span><strong>${parseFloat(
                              data.frais_livraison
                            ).toFixed(2)} €</strong></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 1.2em; margin-top: 10px; padding-top: 10px; border-top: 2px solid #eee;">
                            <span>Total TTC</span>
                            <span><strong>${parseFloat(data.total).toFixed(
                              2
                            )} €</strong></span>
                        </div>
                    </div>`;

            document.getElementById("orderSummary").innerHTML = html;
          }
        } catch (error) {
          console.error("Erreur:", error);
          document.getElementById("orderSummary").innerHTML =
            "<p>Erreur de chargement du récapitulatif</p>";
        }
      }

      function submitOrder() {
        // Validation simple
        const requiredFields = [
          "prenom",
          "nom",
          "email",
          "adresse",
          "code_postal",
          "ville",
          "telephone",
        ];
        let isValid = true;

        requiredFields.forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          if (!field.value.trim()) {
            field.style.borderColor = "red";
            isValid = false;
          } else {
            field.style.borderColor = "";
          }
        });

        if (!isValid) {
          alert("Veuillez remplir tous les champs obligatoires (*)");
          return;
        }

        // Simuler la soumission
        alert("Formulaire validé ! Redirection vers le paiement...");

        // Stocker en session localStorage pour simuler
        const orderData = {
          prenom: document.getElementById("prenom").value,
          nom: document.getElementById("nom").value,
          email: document.getElementById("email").value,
          adresse: document.getElementById("adresse").value,
          code_postal: document.getElementById("code_postal").value,
          ville: document.getElementById("ville").value,
          telephone: document.getElementById("telephone").value,
        };

        localStorage.setItem("orderData", JSON.stringify(orderData));

        // Rediriger vers une page de paiement
        window.location.href = "paiement.html";
      }

      // Charger le récapitulatif au chargement de la page
      document.addEventListener("DOMContentLoaded", loadOrderSummary);
    </script>
  </body>
</html>
