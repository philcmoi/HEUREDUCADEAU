<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mon Panier - HEURE DU CADEAU</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/panier.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <style>
      /* Styles pour l'√©tat vide du panier */
      .cart-empty {
        display: none; /* Cach√© par d√©faut */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        text-align: center;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px dashed #ddd;
        margin: 20px 0;
      }

      .cart-empty i {
        font-size: 4rem;
        color: #bdc3c7;
        margin-bottom: 20px;
      }

      .cart-empty h3 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .cart-empty p {
        color: #7f8c8d;
        margin-bottom: 30px;
        max-width: 400px;
      }

      /* Styles pour les vraies infos produits */
      .cart-item-category {
        font-size: 0.8rem;
        color: #3498db;
        margin: 5px 0;
        font-weight: 500;
      }

      .cart-item-desc {
        font-size: 0.85rem;
        color: #666;
        margin: 5px 0;
        line-height: 1.3;
        max-height: 40px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .cart-item-rating {
        margin: 5px 0;
      }

      .cart-item-rating .stars {
        color: #f1c40f;
        font-size: 0.9rem;
      }

      .stock-info {
        display: block;
        font-size: 0.75rem;
        color: #7f8c8d;
        margin-top: 5px;
        text-align: center;
      }

      /* Notification am√©lior√©e */
      @keyframes notificationSlideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes notificationSlideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      /* Animation du compteur */
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      .cart-count.pulse {
        animation: pulse 0.6s ease-in-out;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container header-container">
        <a href="index.html" class="logo">
          <i class="fas fa-gift logo-icon"></i>
          <span class="logo-text"
            >HEURE<span class="logo-highlight">DU CADEAU</span></span
          >
        </a>

        <nav class="nav-main">
          <ul class="nav-list">
            <li>
              <a href="index.html" class="nav-link"
                ><i class="fas fa-home"></i> Accueil</a
              >
            </li>
            <li>
              <a href="produits.php" class="nav-link"
                ><i class="fas fa-box-open"></i> Cadeaux</a
              >
            </li>
            <li>
              <a href="apropos.html" class="nav-link"
                ><i class="fas fa-info-circle"></i> √Ä propos</a
              >
            </li>
            <li>
              <a href="contact.html" class="nav-link"
                ><i class="fas fa-envelope"></i> Contact</a
              >
            </li>
            <li>
              <a href="panier.html" class="nav-link cart-link">
                <i class="fas fa-shopping-cart"></i> Panier
                <span class="cart-count">0</span>
              </a>
            </li>
          </ul>
        </nav>

        <button class="menu-toggle" id="menuToggle">
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <!-- Navigation mobile -->
      <nav class="nav-mobile" id="navMobile">
        <ul class="nav-mobile-list">
          <li>
            <a href="index.html" class="nav-mobile-link"
              ><i class="fas fa-home"></i> Accueil</a
            >
          </li>
          <li>
            <a href="produits.php" class="nav-mobile-link"
              ><i class="fas fa-box-open"></i> Cadeaux</a
            >
          </li>
          <li>
            <a href="apropos.html" class="nav-mobile-link"
              ><i class="fas fa-info-circle"></i> √Ä propos</a
            >
          </li>
          <li>
            <a href="contact.html" class="nav-mobile-link"
              ><i class="fas fa-envelope"></i> Contact</a
            >
          </li>
          <li>
            <a href="panier.html" class="nav-mobile-link"
              ><i class="fas fa-shopping-cart"></i> Panier</a
            >
          </li>
        </ul>
      </nav>
    </header>

    <!-- Section Panier -->
    <section class="cart-hero">
      <div class="container">
        <div class="cart-hero-content">
          <h1><i class="fas fa-shopping-cart"></i> Mon Panier</h1>
          <p class="cart-subtitle">
            R√©visez vos articles et finalisez votre commande
          </p>
          <div class="cart-progress">
            <div class="progress-step active">
              <span class="step-number">1</span>
              <span class="step-text">Panier</span>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step">
              <span class="step-number">2</span>
              <span class="step-text">Livraison</span>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step">
              <span class="step-number">3</span>
              <span class="step-text">Paiement</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <main class="cart-page">
      <div class="container">
        <div class="cart-layout">
          <!-- Section principale - Articles du panier -->
          <div class="cart-main">
            <div class="cart-header">
              <h2><i class="fas fa-box"></i> Votre s√©lection</h2>
              <button class="btn btn-secondary" id="clearCartBtn">
                <i class="fas fa-trash"></i> Vider le panier
              </button>
            </div>

            <!-- Liste des articles -->
            <div class="cart-items-wrapper">
              <div class="cart-items" id="cartItems">
                <!-- Panier vide par d√©faut -->
                <div class="cart-empty" id="cartEmpty">
                  <i class="fas fa-shopping-cart fa-3x"></i>
                  <h3>Votre panier est vide</h3>
                  <p>Ajoutez des produits pour commencer vos achats</p>
                  <a href="produits.php" class="btn btn-primary">
                    <i class="fas fa-shopping-bag"></i> D√©couvrir nos produits
                  </a>
                </div>
                <!-- Les articles seront charg√©s ici par JavaScript -->
              </div>
            </div>

            <!-- Informations suppl√©mentaires -->
            <div class="cart-extra-info">
              <div class="extra-info-card">
                <i class="fas fa-gift"></i>
                <h4>Emballage cadeau</h4>
                <p>Ajoutez un emballage √©l√©gant pour 3,90‚Ç¨ seulement</p>
                <div class="gift-wrap-toggle">
                  <span class="toggle-label">Emballage cadeau</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="giftWrapToggle" />
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
              <div class="extra-info-card">
                <i class="fas fa-truck"></i>
                <h4>Livraison offerte</h4>
                <p>
                  Votre commande b√©n√©ficie de la livraison gratuite en France
                  m√©tropolitaine
                </p>
              </div>
            </div>
          </div>

          <!-- Sidebar - R√©capitulatif -->
          <aside class="cart-sidebar">
            <div class="sidebar-card">
              <h3><i class="fas fa-receipt"></i> R√©capitulatif</h3>

              <div class="summary-details">
                <div class="summary-row">
                  <span>Sous-total</span>
                  <span id="subtotal">0,00 ‚Ç¨</span>
                </div>
                <div class="summary-row">
                  <span>Livraison</span>
                  <span class="free-shipping">Gratuite</span>
                </div>
                <div class="summary-row">
                  <span>Emballage cadeau</span>
                  <span id="giftWrapPrice">0,00 ‚Ç¨</span>
                </div>
                <div class="summary-divider"></div>
                <div class="summary-row total">
                  <span>Total TTC</span>
                  <span id="total">0,00 ‚Ç¨</span>
                </div>
              </div>

              <!-- Code promotionnel -->
              <div class="promo-code-section">
                <div class="promo-code-input">
                  <input
                    type="text"
                    id="promoCodeInput"
                    placeholder="Code promotionnel"
                  />
                  <button id="applyPromoBtn" class="btn-promo">
                    Appliquer
                  </button>
                </div>
                <div
                  class="promo-success"
                  id="promoSuccess"
                  style="display: none"
                >
                  <i class="fas fa-check-circle"></i>
                  <span>Code appliqu√© avec succ√®s !</span>
                </div>
              </div>

              <!-- Boutons d'action -->
              <div class="cart-actions">
                <button class="btn btn-primary btn-checkout" id="checkoutBtn">
                  <i class="fas fa-lock"></i> Proc√©der au paiement
                </button>
                <a href="index.html" class="btn btn-secondary">
                  <i class="fas fa-shopping-bag"></i> Continuer mes achats
                </a>
              </div>

              <!-- Garanties -->
              <div class="guarantees">
                <div class="guarantee-item">
                  <i class="fas fa-shield-alt"></i>
                  <span>Paiement s√©curis√©</span>
                </div>
                <div class="guarantee-item">
                  <i class="fas fa-undo"></i>
                  <span>Retour sous 30 jours</span>
                </div>
                <div class="guarantee-item">
                  <i class="fas fa-headset"></i>
                  <span>Service client 7j/7</span>
                </div>
              </div>
            </div>

            <!-- S√©curit√© -->
            <div class="security-notice">
              <i class="fas fa-lock"></i>
              <div>
                <h4>Transaction s√©curis√©e</h4>
                <p>
                  Vos donn√©es sont prot√©g√©es par un chiffrement SSL 256 bits
                </p>
              </div>
            </div>
          </aside>
        </div>

        <!-- Produits sugg√©r√©s -->
        <section class="suggested-products">
          <h3><i class="fas fa-heart"></i> Compl√©tez votre panier</h3>
          <div class="suggested-grid" id="suggestedProducts">
            <!-- Les produits sugg√©r√©s seront charg√©s ici -->
          </div>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-grid">
          <div class="footer-col">
            <h4>HEURE DU CADEAUX</h4>
            <p>
              Votre boutique de cadeaux d'exception pour toutes les occasions
              sp√©ciales.
            </p>
            <div class="social-links">
              <a href="#"><i class="fab fa-facebook"></i></a>
              <a href="#"><i class="fab fa-instagram"></i></a>
              <a href="#"><i class="fab fa-pinterest"></i></a>
              <a href="#"><i class="fab fa-tiktok"></i></a>
            </div>
          </div>
          <div class="footer-col">
            <h4>Boutique</h4>
            <ul>
              <li><a href="produits.php">Tous les produits</a></li>
              <li>
                <a href="produits.php?categorie=nouveautes">Nouveaut√©s</a>
              </li>
              <li>
                <a href="produits.php?categorie=meilleures-ventes"
                  >Meilleures ventes</a
                >
              </li>
              <li>
                <a href="produits.php?categorie=promotions">Promotions</a>
              </li>
            </ul>
          </div>
          <div class="footer-col">
            <h4>Informations</h4>
            <ul>
              <li><a href="apropos.html">√Ä propos</a></li>
              <li><a href="contact.html">Contact</a></li>
              <li><a href="livraison.html">Livraison</a></li>
              <li><a href="retours.html">Retours & √âchanges</a></li>
              <li><a href="confidentialite.html">Confidentialit√©</a></li>
              <li><a href="cgv.html">CGV</a></li>
            </ul>
          </div>
          <div class="footer-col">
            <h4>Contact</h4>
            <ul class="contact-info">
              <li><i class="fas fa-envelope"></i> contact@HEUREDUCADEAU.fr</li>
              <li><i class="fas fa-phone"></i> 01 23 45 67 89</li>
              <li><i class="fas fa-map-marker-alt"></i> Paris, France</li>
            </ul>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 HEURE DU CADEAU. Tous droits r√©serv√©s.</p>
          <div class="payment-methods">
            <i class="fab fa-cc-visa"></i>
            <i class="fab fa-cc-mastercard"></i>
            <i class="fab fa-cc-paypal"></i>
            <i class="fab fa-cc-apple-pay"></i>
          </div>
        </div>
      </div>
    </footer>

    <!-- Scripts -->
    <script src="js/main.js"></script>
    <script>
      // ==============================================
      // GESTION DU PANIER - VERSION COMPL√àTE AVEC BDD
      // ==============================================

      // Configuration - UTILISEZ LE CHEMIN ABSOLU
      const API_BASE_URL = "/api/panier.php";
      console.log("API URL configur√©e:", API_BASE_URL);

      // Test imm√©diat de l'API
      async function testAPI() {
        try {
          console.log("Test API en cours...");
          const response = await fetch(API_BASE_URL + "?action=compter");
          const data = await response.json();
          console.log("Test API r√©ussi:", data);
          return data.success;
        } catch (error) {
          console.error("Test API √©chou√©:", error);
          return false;
        }
      }

      // Fonction pour afficher une notification
      function showNotification(message, type = "success") {
        // Supprimer les anciennes notifications
        const oldNotifications =
          document.querySelectorAll(".cart-notification");
        oldNotifications.forEach((n) => n.remove());

        // Cr√©er la notification
        const notification = document.createElement("div");
        notification.className = `cart-notification ${type}`;

        const icon =
          type === "success" ? "check-circle" : "exclamation-triangle";
        notification.innerHTML = `
          <i class="fas fa-${icon}"></i>
          <span>${message}</span>
          <button class="notification-close"><i class="fas fa-times"></i></button>
        `;

        // Styles inline pour √™tre s√ªr
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === "success" ? "#27ae60" : "#e74c3c"};
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          display: flex;
          align-items: center;
          gap: 10px;
          z-index: 10000;
          font-family: 'Poppins', sans-serif;
          font-size: 14px;
          animation: notificationSlideIn 0.3s ease;
        `;

        // Bouton fermer
        const closeBtn = notification.querySelector(".notification-close");
        closeBtn.style.cssText = `
          background: transparent;
          border: none;
          color: white;
          cursor: pointer;
          font-size: 14px;
          margin-left: 10px;
          padding: 2px 6px;
          border-radius: 50%;
          transition: background 0.2s;
        `;

        closeBtn.addEventListener("mouseover", () => {
          closeBtn.style.background = "rgba(255,255,255,0.2)";
        });

        closeBtn.addEventListener("mouseout", () => {
          closeBtn.style.background = "transparent";
        });

        closeBtn.addEventListener("click", () => {
          notification.style.animation = "notificationSlideOut 0.3s ease";
          setTimeout(() => notification.remove(), 300);
        });

        document.body.appendChild(notification);

        // Auto-suppression apr√®s 4 secondes
        setTimeout(() => {
          if (notification.parentElement) {
            notification.style.animation = "notificationSlideOut 0.3s ease";
            setTimeout(() => {
              if (notification.parentElement) {
                notification.remove();
              }
            }, 300);
          }
        }, 4000);
      }

      // Fonction pour g√©n√©rer les √©toiles
      function generateStars(rating) {
        let stars = "";
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating - fullStars >= 0.5;

        for (let i = 0; i < 5; i++) {
          if (i < fullStars) {
            stars += '<i class="fas fa-star"></i>';
          } else if (i === fullStars && hasHalfStar) {
            stars += '<i class="fas fa-star-half-alt"></i>';
          } else {
            stars += '<i class="far fa-star"></i>';
          }
        }
        return stars;
      }

      // Mettre √† jour le compteur du panier
      async function mettreAJourCompteur() {
        try {
          console.log("üìä Mise √† jour compteur...");
          const response = await fetch(API_BASE_URL + "?action=compter");

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          console.log("‚úÖ Donn√©es compteur:", data);

          if (data.success) {
            const cartCountElements = document.querySelectorAll(".cart-count");
            cartCountElements.forEach((el) => {
              el.textContent = data.total;
              el.style.display = data.total > 0 ? "inline-flex" : "none";

              // Animation pulse
              if (data.total > 0) {
                el.classList.add("pulse");
                setTimeout(() => el.classList.remove("pulse"), 600);
              }
            });
            return data.total;
          }
        } catch (error) {
          console.error("‚ùå Erreur compteur:", error);
          return 0;
        }
      }

      // Charger les articles du panier
      async function chargerPanier() {
        console.log("üõí Chargement panier...");
        try {
          const response = await fetch(API_BASE_URL + "?action=get");

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          console.log("‚úÖ Panier charg√©:", data);

          if (data.success) {
            afficherArticlesPanier(data.items || [], data.total_prix || 0);
          } else {
            console.error("‚ùå Erreur API:", data.message);
            afficherArticlesPanier([], 0);
          }
        } catch (error) {
          console.error("‚ùå Erreur chargement:", error);
          afficherArticlesPanier([], 0);
        }
      }

      // Afficher les articles dans le panier - VERSION AVEC VRAIES INFOS BDD
      function afficherArticlesPanier(items, totalPrix) {
        const container = document.getElementById("cartItems");
        const cartEmpty = document.getElementById("cartEmpty");
        const subtotalElement = document.getElementById("subtotal");
        const totalElement = document.getElementById("total");

        console.log(`üì¶ ${items.length} articles √† afficher`);

        // G√©rer panier vide
        if (!items || items.length === 0) {
          console.log("üîÑ Affichage: Panier vide");

          if (container) {
            container.innerHTML = "";
          }

          if (cartEmpty) {
            cartEmpty.style.display = "flex";
          }

          if (subtotalElement) subtotalElement.textContent = "0,00 ‚Ç¨";
          if (totalElement) totalElement.textContent = "0,00 ‚Ç¨";

          // D√©sactiver bouton paiement
          const checkoutBtn = document.getElementById("checkoutBtn");
          if (checkoutBtn) {
            checkoutBtn.disabled = true;
            checkoutBtn.style.opacity = "0.6";
            checkoutBtn.style.cursor = "not-allowed";
          }

          return;
        }

        // Panier NON vide
        console.log("üîÑ Affichage: Panier avec", items.length, "articles");

        if (cartEmpty) {
          cartEmpty.style.display = "none";
        }

        // R√©activer bouton paiement
        const checkoutBtn = document.getElementById("checkoutBtn");
        if (checkoutBtn) {
          checkoutBtn.disabled = false;
          checkoutBtn.style.opacity = "1";
          checkoutBtn.style.cursor = "pointer";
        }

        // G√©n√©rer HTML des articles avec VRAIES infos
        let html = "";
        items.forEach((item) => {
          const prixUnitaire = parseFloat(item.prix_unitaire || 0);
          const quantite = parseInt(item.quantite) || 1;
          const totalItem = prixUnitaire * quantite;
          const stockMax = item.stock_max || 99;

          // Formater les prix
          const prixUnitaireFormatted = prixUnitaire
            .toFixed(2)
            .replace(".", ",");
          const totalItemFormatted = totalItem.toFixed(2).replace(".", ",");

          // Image par d√©faut si vide
          const imageUrl =
            item.image &&
            item.image !== "null" &&
            item.image !== "img/default-product.jpg"
              ? item.image
              : "img/default-product.jpg";

          html += `
      <div class="cart-item" data-item-id="${item.id_item}" data-produit-id="${
            item.id_produit
          }">
        <div class="cart-item-image">
          <img src="${imageUrl}" alt="${item.nom}" 
               onerror="this.src='img/default-product.jpg'">
        </div>
        <div class="cart-item-details">
          <h4 class="cart-item-title">${item.nom}</h4>
          ${
            item.categorie
              ? `<p class="cart-item-category">${item.categorie}</p>`
              : ""
          }
          ${
            item.description
              ? `<p class="cart-item-desc">${item.description}</p>`
              : ""
          }
          <p class="cart-item-ref">R√©f: ${item.id_produit
            .toString()
            .padStart(6, "0")}</p>
          <p class="cart-item-price-unit">${prixUnitaireFormatted} ‚Ç¨ l'unit√©</p>
          ${
            item.note > 0
              ? `
          <div class="cart-item-rating">
            <div class="stars">
              ${generateStars(item.note)}
            </div>
          </div>`
              : ""
          }
        </div>
        <div class="cart-item-quantity">
          <button class="quantity-btn minus" onclick="modifierQuantite('${
            item.id_item
          }', -1)" 
                  ${quantite <= 1 ? "disabled" : ""}>
            <i class="fas fa-minus"></i>
          </button>
          <input type="number" value="${quantite}" min="1" max="${stockMax}" 
                 class="quantity-input" data-item-id="${item.id_item}"
                 onchange="mettreAJourQuantite('${item.id_item}', this.value)"
                 title="Stock disponible: ${stockMax}">
          <button class="quantity-btn plus" onclick="modifierQuantite('${
            item.id_item
          }', 1)"
                  ${quantite >= stockMax ? "disabled" : ""}>
            <i class="fas fa-plus"></i>
          </button>
          <small class="stock-info">Stock: ${stockMax}</small>
        </div>
        <div class="cart-item-total">
          <span class="item-total-price">${totalItemFormatted} ‚Ç¨</span>
        </div>
        <button class="cart-item-remove" onclick="supprimerArticle('${
          item.id_item
        }')" 
                title="Supprimer">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
        });

        if (container) {
          container.innerHTML = html;
        }

        // Mettre √† jour les totaux
        const formattedTotal = parseFloat(totalPrix || 0)
          .toFixed(2)
          .replace(".", ",");
        if (subtotalElement)
          subtotalElement.textContent = formattedTotal + " ‚Ç¨";
        if (totalElement) totalElement.textContent = formattedTotal + " ‚Ç¨";

        updateTotal();
      }

      // Modifier quantit√© via input
      async function mettreAJourQuantite(itemId, nouvelleQuantite) {
        nouvelleQuantite = parseInt(nouvelleQuantite);
        if (isNaN(nouvelleQuantite) || nouvelleQuantite < 1)
          nouvelleQuantite = 1;
        if (nouvelleQuantite > 99) nouvelleQuantite = 99;

        try {
          const response = await fetch(API_BASE_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "modifier",
              id_item: itemId,
              quantite: nouvelleQuantite,
            }),
          });

          const data = await response.json();
          if (data.success) {
            await chargerPanier();
            await mettreAJourCompteur();
            showNotification("Quantit√© mise √† jour");
          } else {
            showNotification("Erreur: " + data.message, "error");
            await chargerPanier();
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("Erreur de connexion", "error");
        }
      }

      // Modifier quantit√© (+/- boutons)
      async function modifierQuantite(itemId, changement) {
        try {
          const input = document.querySelector(
            `input[data-item-id="${itemId}"]`
          );
          if (!input) return;

          let nouvelleQuantite = parseInt(input.value) + changement;
          if (nouvelleQuantite < 1) nouvelleQuantite = 1;
          if (nouvelleQuantite > 99) nouvelleQuantite = 99;

          const response = await fetch(API_BASE_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "modifier",
              id_item: itemId,
              quantite: nouvelleQuantite,
            }),
          });

          const data = await response.json();
          if (data.success) {
            await chargerPanier();
            await mettreAJourCompteur();
          } else {
            showNotification("Erreur: " + data.message, "error");
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("Erreur de connexion", "error");
        }
      }

      // Supprimer un article
      async function supprimerArticle(itemId) {
        if (
          !confirm("Voulez-vous vraiment supprimer cet article du panier ?")
        ) {
          return;
        }

        try {
          const response = await fetch(API_BASE_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "supprimer",
              id_item: itemId,
            }),
          });

          const data = await response.json();
          if (data.success) {
            showNotification("Article supprim√© du panier");
            await chargerPanier();
            await mettreAJourCompteur();
          } else {
            showNotification("Erreur: " + data.message, "error");
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("Erreur de connexion", "error");
        }
      }

      // VIDER LE PANIER
      function initialiserBoutonViderPanier() {
        const clearCartBtn = document.getElementById("clearCartBtn");
        if (!clearCartBtn) return;

        clearCartBtn.addEventListener("click", async function () {
          if (!confirm("Voulez-vous vraiment vider tout votre panier ?")) {
            return;
          }

          try {
            console.log("üîÑ Tentative de vider le panier...");

            // D√©sactiver le bouton pendant l'op√©ration
            clearCartBtn.disabled = true;
            const originalText = clearCartBtn.innerHTML;
            clearCartBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Vider...';

            // Appel API
            const url = API_BASE_URL + "?action=vider&confirmation=1";
            console.log("URL appel√©e:", url);

            const response = await fetch(url, {
              method: "GET",
              cache: "no-cache",
            });

            console.log(
              "üì° Statut r√©ponse:",
              response.status,
              response.statusText
            );

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const data = await response.json();
            console.log("‚úÖ Donn√©es re√ßues:", data);

            if (data.success) {
              showNotification("‚úÖ Panier vid√© avec succ√®s !");

              // Mettre √† jour l'affichage
              setTimeout(async () => {
                await mettreAJourCompteur();
                await chargerPanier();

                // Forcer l'affichage du message "panier vide"
                const cartEmpty = document.getElementById("cartEmpty");
                if (cartEmpty) cartEmpty.style.display = "flex";

                // R√©initialiser les totaux
                document.getElementById("subtotal").textContent = "0,00 ‚Ç¨";
                document.getElementById("total").textContent = "0,00 ‚Ç¨";
                document.getElementById("giftWrapPrice").textContent = "0,00 ‚Ç¨";

                // D√©cocher l'emballage cadeau
                const giftWrapToggle =
                  document.getElementById("giftWrapToggle");
                if (giftWrapToggle) giftWrapToggle.checked = false;

                console.log("‚úÖ Panier rafra√Æchi visuellement");
              }, 100);
            } else {
              showNotification("‚ùå Erreur: " + data.message, "error");
            }
          } catch (error) {
            console.error("‚ùå Erreur d√©taill√©e:", error);
            showNotification("‚ùå Erreur lors du vidage du panier", "error");
          } finally {
            // R√©activer le bouton
            setTimeout(() => {
              clearCartBtn.disabled = false;
              clearCartBtn.innerHTML = originalText;
            }, 500);
          }
        });
      }

      // Gestion emballage cadeau
      function initialiserEmballageCadeau() {
        const giftWrapToggle = document.getElementById("giftWrapToggle");
        if (!giftWrapToggle) return;

        giftWrapToggle.addEventListener("change", function (e) {
          const giftWrapPrice = document.getElementById("giftWrapPrice");
          giftWrapPrice.textContent = e.target.checked ? "3,90 ‚Ç¨" : "0,00 ‚Ç¨";
          updateTotal();
        });
      }

      // Mettre √† jour le total
      function updateTotal() {
        const subtotalText = document.getElementById("subtotal").textContent;
        const subtotal =
          parseFloat(subtotalText.replace(" ‚Ç¨", "").replace(",", ".")) || 0;
        const giftWrapChecked =
          document.getElementById("giftWrapToggle")?.checked || false;
        const giftWrapCost = giftWrapChecked ? 3.9 : 0;

        const total = subtotal + giftWrapCost;
        const totalFormatted = total.toFixed(2).replace(".", ",") + " ‚Ç¨";
        document.getElementById("total").textContent = totalFormatted;
      }

      // Code promotionnel
      function initialiserCodePromo() {
        const applyPromoBtn = document.getElementById("applyPromoBtn");
        if (!applyPromoBtn) return;

        applyPromoBtn.addEventListener("click", function () {
          const promoCode = document
            .getElementById("promoCodeInput")
            .value.trim();
          if (promoCode) {
            const promoSuccess = document.getElementById("promoSuccess");
            promoSuccess.style.display = "flex";

            setTimeout(() => {
              promoSuccess.style.display = "none";
            }, 3000);

            document.getElementById("promoCodeInput").value = "";
            showNotification("üéâ Code promotionnel appliqu√© !");
          }
        });
      }

      // Proc√©der au paiement
      function initialiserPaiement() {
        const checkoutBtn = document.getElementById("checkoutBtn");
        if (!checkoutBtn) return;

        checkoutBtn.addEventListener("click", function () {
          const totalText = document.getElementById("total").textContent;
          const total = parseFloat(
            totalText.replace(" ‚Ç¨", "").replace(",", ".")
          );

          if (total <= 0) {
            showNotification(
              "üõí Votre panier est vide. Ajoutez des produits avant de proc√©der au paiement.",
              "error"
            );
            return;
          }

          showNotification("üîí Redirection vers la page de paiement...");
          // window.location.href = 'paiement.php?total=' + total;
        });
      }

      // Synchroniser le panier avec la BDD
      async function synchroniserPanier() {
        try {
          console.log("üîÑ Synchronisation du panier...");
          const response = await fetch(API_BASE_URL + "?action=sync");
          const data = await response.json();

          if (data.success) {
            if (
              data.items_updated.length > 0 ||
              data.items_removed.length > 0
            ) {
              console.log("‚úÖ Panier synchronis√©:", data);
              await chargerPanier();
              await mettreAJourCompteur();

              if (data.items_updated.length > 0) {
                showNotification(
                  "‚ö†Ô∏è Certains articles ont √©t√© ajust√©s au stock disponible",
                  "error"
                );
              }
              if (data.items_removed.length > 0) {
                showNotification(
                  "‚ö†Ô∏è Certains articles indisponibles ont √©t√© retir√©s",
                  "error"
                );
              }
            }
          }
        } catch (error) {
          console.error("‚ùå Erreur synchronisation:", error);
        }
      }

      // Initialisation principale
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("üöÄ Page panier - Initialisation d√©marr√©e");

        // Tester l'API imm√©diatement
        const apiOk = await testAPI();
        console.log("API status:", apiOk ? "‚úÖ OK" : "‚ùå √âchec");

        if (!apiOk) {
          showNotification("‚ö†Ô∏è API panier non disponible", "error");
        }

        // Mettre √† jour compteur
        await mettreAJourCompteur();

        // Synchroniser le panier avec la BDD
        await synchroniserPanier();

        // Initialiser composants
        initialiserBoutonViderPanier();
        initialiserEmballageCadeau();
        initialiserCodePromo();
        initialiserPaiement();

        // Si sur page panier, charger les articles
        if (window.location.pathname.includes("panier.html")) {
          console.log("üìÑ Page panier d√©tect√©e - Chargement articles...");
          await chargerPanier();
        }

        console.log("‚úÖ Initialisation termin√©e");
      });

      // Exposer les fonctions globalement
      window.ajouterAuPanier = async function (idProduit) {
        console.log("‚ûï Ajout produit ID:", idProduit);
        try {
          const response = await fetch(API_BASE_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "ajouter",
              id_produit: idProduit,
              quantite: 1,
            }),
          });

          const data = await response.json();
          console.log("R√©ponse ajout:", data);

          if (data.success) {
            await mettreAJourCompteur();
            if (window.location.pathname.includes("panier.html")) {
              await chargerPanier();
            }
            showNotification(`üéÅ "${data.produit_nom}" ajout√© au panier !`);
            return true;
          } else {
            showNotification("‚ùå Erreur: " + data.message, "error");
            return false;
          }
        } catch (error) {
          console.error("Erreur ajout:", error);
          showNotification("‚ùå Erreur de connexion", "error");
          return false;
        }
      };

      window.modifierQuantite = modifierQuantite;
      window.supprimerArticle = supprimerArticle;
      window.mettreAJourQuantite = mettreAJourQuantite;
      window.chargerPanier = chargerPanier;
      window.mettreAJourCompteur = mettreAJourCompteur;
      window.synchroniserPanier = synchroniserPanier;

      // Fonction de test manuel
      window.testViderPanier = async function () {
        console.log("üß™ Test manuel vider panier...");
        const url = API_BASE_URL + "?action=vider&confirmation=1";
        console.log("URL test:", url);

        try {
          const response = await fetch(url);
          const data = await response.json();
          console.log("R√©sultat test:", data);
          return data;
        } catch (error) {
          console.error("Test √©chou√©:", error);
          return null;
        }
      };
    </script>
  </body>
</html>
